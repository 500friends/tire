<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>percolated-twitter.rb</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>percolated-twitter.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-Reversed_or_“Real_Time”_Search_in_ElasticSearch'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Reversed_or_“Real_Time”_Search_in_ElasticSearch">&#182;</a>
        </div>
        <h1>Reversed or “Real Time” Search in ElasticSearch</h1>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <p>You may have come across the term “realtime search” lately
(eg. <a href="http://engineering.socialcast.com/2011/05/realtime-search-solr-vs-elasticsearch/">here</a>)
and wondered what all the fuss is about.</p>

<p>Well, the usual workflow with search engines goes like this:</p>

<ol>
<li>You index some documents.</li>
<li>You perform a search query.</li>
</ol>

<p>In <a href="http://www.elasticsearch.org/"><em>ElasticSearch</em></a>, there&rsquo;s a default delay
of 1 second between indexing a document and being able to search it.
You can, of course, force refresh the index. That&rsquo;s enough “realtime”
in my book, if you ask me.</p>

<p>However, <em>ElasticSearch</em> comes with a much more powerful idea for “realtime seach”,
called <a href="http://www.elasticsearch.org/guide/reference/api/percolate.html"><em>percolation</em></a>.</p>

<p>It <em>reverses</em> the usual workflow like this:</p>

<ol>
<li>You register some queries you&rsquo;d like to perform in real time, on demand,
or <em>while the documents are being indexed</em>.</li>
<li>You index some documents.</li>
</ol>

<p>The search engine will match your documents against your queries, and return names of matching queries
in the response. Yes, <em>names</em>.</p>

<p>This allows you to do crazy stuff immediately, <em>while your documents are being indexed</em>.
Think <a href="http://www.google.com/alerts">Google Alerts</a> for <em>your</em> data.</p>

<p>The <em>Tire</em> gem for <em>ElasticSearch</em> recently got
<a href="(http://karmi.github.com/tire/#section-Percolation">percolation support</a>).</p>

<p>In this script, we&rsquo;ll register couple of queries, and then fetch data from <em>Twitter</em>,
receiving notifications when any status message matches one of our queries.</p>

<p>You can download this script at <a href="https://gist.github.com/1025498">https://gist.github.com/1025498</a>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>First of all, let&rsquo;s install some gems:</p>

<pre><code>gem install tire ansi yajl-ruby
</code></pre>

<p>Note that you need the 0.1.11 version of the <code>tire</code> gem.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;time&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;uri&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;tire&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;ansi/code&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;yajl/http_stream&#39;</span>

<span class="kp">include</span> <span class="no">ANSI</span><span class="o">::</span><span class="no">Code</span></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <p>Let&rsquo;s define a class to hold our data in <em>ElasticSearch</em>.</p>

<p>We&rsquo;re using the <em>persistence</em> mode of <em>Tire</em>, so we don&rsquo;t need a database, because 
<a href="http://www.slideshare.net/karmi/your-data-your-search-elasticsearch-euruko-2011/49"><em>the index is our database</em></a>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">class</span> <span class="nc">Status</span>
  <span class="kp">include</span> <span class="no">Tire</span><span class="o">::</span><span class="no">Model</span><span class="o">::</span><span class="no">Persistence</span>

  <span class="n">property</span> <span class="ss">:user</span>
  <span class="n">property</span> <span class="ss">:text</span>
  <span class="n">property</span> <span class="ss">:created_at</span></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>Let&rsquo;s define callback for percolation.
Whenewer a new document is saved in the index, this block will be executed,
and we will have access to matching queries in the <code>Status#matches</code> property.</p>

<p>In our case, we will just print the list of matching queries.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">on_percolate</span> <span class="k">do</span>
    <span class="nb">puts</span> <span class="n">green</span> <span class="p">{</span> <span class="s2">&quot;&#39;</span><span class="si">#{</span><span class="n">text</span><span class="si">}</span><span class="s2">&#39; from @</span><span class="si">#{</span><span class="n">user</span><span class="si">}</span><span class="s2"> matches queries: </span><span class="si">#{</span><span class="n">matches</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">&quot;</span> <span class="p">}</span> <span class="k">unless</span> <span class="n">matches</span><span class="o">.</span><span class="n">empty?</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <p>Let&rsquo;s register the queries for percolation now.</p>

<p>First, let&rsquo;s define the query_string queries.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">q</span>            <span class="o">=</span> <span class="p">{}</span>
<span class="n">q</span><span class="o">[</span><span class="ss">:newspeak</span><span class="o">]</span> <span class="o">=</span> <span class="s1">&#39;wow omg lol wtf fuu*&#39;</span>
<span class="n">q</span><span class="o">[</span><span class="ss">:fail</span><span class="o">]</span>     <span class="o">=</span> <span class="s1">&#39;fail&#39;</span>
<span class="n">q</span><span class="o">[</span><span class="ss">:memes</span><span class="o">]</span>    <span class="o">=</span> <span class="s1">&#39;&quot;why u no&quot; &quot;all your base&quot; &quot;i can has&quot;&#39;</span></pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p>Second, let&rsquo;s save those queries in <em>ElasticSearch</em>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="no">Status</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">register_percolator_query</span><span class="p">(</span><span class="s1">&#39;newspeak&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">query</span><span class="o">|</span> <span class="n">query</span><span class="o">.</span><span class="n">string</span> <span class="n">q</span><span class="o">[</span><span class="ss">:newspeak</span><span class="o">]</span> <span class="p">}</span>
<span class="no">Status</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">register_percolator_query</span><span class="p">(</span><span class="s1">&#39;fails&#39;</span><span class="p">)</span>    <span class="p">{</span> <span class="o">|</span><span class="n">query</span><span class="o">|</span> <span class="n">query</span><span class="o">.</span><span class="n">string</span> <span class="n">q</span><span class="o">[</span><span class="ss">:fail</span><span class="o">]</span> <span class="p">}</span>
<span class="no">Status</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">register_percolator_query</span><span class="p">(</span><span class="s1">&#39;memes&#39;</span><span class="p">)</span>    <span class="p">{</span> <span class="o">|</span><span class="n">query</span><span class="o">|</span> <span class="n">query</span><span class="o">.</span><span class="n">string</span> <span class="n">q</span><span class="o">[</span><span class="ss">:memes</span><span class="o">]</span> <span class="p">}</span>

<span class="nb">puts</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">bold</span> <span class="p">{</span> <span class="s2">&quot;Testing percolation&quot;</span> <span class="p">},</span> <span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">80</span></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <p>Let&rsquo;s check out the percolation on some “example data”.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">status</span> <span class="o">=</span> <span class="no">Status</span><span class="o">.</span><span class="n">new</span> <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="s1">&#39;OMG i can has #fail&#39;</span>
<span class="nb">puts</span> <span class="s2">&quot;&#39;</span><span class="si">#{</span><span class="n">status</span><span class="o">.</span><span class="n">text</span><span class="si">}</span><span class="s2">&#39; matches queries </span><span class="si">#{</span><span class="n">status</span><span class="o">.</span><span class="n">percolate</span><span class="o">.</span><span class="n">inspect</span><span class="si">}</span><span class="s2">&quot;</span></pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-9">&#182;</a>
        </div>
        <p>Now, let&rsquo;s fetch some real data from the collective consciousness.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">url</span>   <span class="o">=</span> <span class="no">URI</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="s2">&quot;http://api.twitter.com/1/statuses/public_timeline.json&quot;</span><span class="p">)</span>
<span class="nb">puts</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">bold</span> <span class="p">{</span> <span class="s2">&quot;Fetching &#39;</span><span class="si">#{</span><span class="n">url</span><span class="si">}</span><span class="s2">&#39;&quot;</span> <span class="p">},</span> <span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">80</span>

<span class="mi">5</span><span class="o">.</span><span class="n">times</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <p>Get JSON data from <em>Twitter</em>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="no">Yajl</span><span class="o">::</span><span class="no">HttpStream</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="ss">:symbolize_keys</span> <span class="o">=&gt;</span> <span class="kp">true</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">timeline</span><span class="o">|</span>
    <span class="n">timeline</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">status</span><span class="o">|</span></pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-11">&#182;</a>
        </div>
        <p>Create new document from each status message.</p>

<p>Watch the output from the <code>on_percolate</code> callback in your console.
You may have to run this file repeatedly, in case <em>Twitter</em> gets quiet.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="no">Status</span><span class="o">.</span><span class="n">create</span> <span class="ss">:id</span> <span class="o">=&gt;</span> <span class="n">status</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">,</span>
                    <span class="ss">:user</span> <span class="o">=&gt;</span> <span class="n">status</span><span class="o">[</span><span class="ss">:user</span><span class="o">][</span><span class="ss">:screen_name</span><span class="o">]</span><span class="p">,</span>
                    <span class="ss">:text</span> <span class="o">=&gt;</span> <span class="n">status</span><span class="o">[</span><span class="ss">:text</span><span class="o">]</span><span class="p">,</span>
                    <span class="ss">:created_at</span> <span class="o">=&gt;</span> <span class="no">Time</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">status</span><span class="o">[</span><span class="ss">:created_at</span><span class="o">]</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="nb">puts</span> <span class="s2">&quot;Indexed </span><span class="si">#{</span><span class="n">timeline</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s2"> tweets&quot;</span>
  <span class="k">end</span>
  <span class="nb">sleep</span> <span class="mi">10</span> <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span>
<span class="k">end</span>

<span class="nb">puts</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">bold</span> <span class="p">{</span> <span class="s2">&quot;Check out your index&quot;</span> <span class="p">},</span> <span class="s1">&#39;-&#39;</span><span class="o">*</span><span class="mi">80</span></pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-12">&#182;</a>
        </div>
        <p>You can check out the the documents in your index with <code>curl</code> or your browser.</p>

      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">puts</span> <span class="s2">&quot;curl &#39;http://localhost:9200/statuses/_search?q=*&amp;sort=created_at:desc&amp;size=5&amp;pretty=true&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
