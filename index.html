<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>slingshot-dsl.rb</title>
  <link rel="stylesheet" href="http://github.com/jashkenas/docco/raw/0.3.0/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>slingshot-dsl.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        <p><strong>Slingshot</strong> is a rich and comfortable Ruby API and DSL for the
<a href="http://www.elasticsearch.org/"><em>ElasticSearch</em></a> search engine/database.</p>

<p><em>ElasticSearch</em> is a scalable, distributed, highly-available,
RESTful database communicating by JSON over HTTP, based on <a href="http://lucene.apache.org/">Lucene</a>,
written in Java. It manages to be very simple and very powerful at the same time.</p>

<p>By following these instructions you should have the search running
on a sane operation system in less then 10 minutes.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-Installation'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Installation">&#182;</a>
        </div>
        <h3>Installation</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>Install Slingshot with Rubygems.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">require</span> <span class="s1">&#39;rubygems&#39;</span>
<span class="nb">require</span> <span class="s1">&#39;slingshot-rb&#39;</span></pre></div>
      </td>
    </tr>
    <tr id='section-Prerequisites'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Prerequisites">&#182;</a>
        </div>
        <h3>Prerequisites</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>You&rsquo;ll need a working and running <em>ElasticSearch</em> server. Thankfully, that&rsquo;s easy.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="p">(</span> <span class="nb">puts</span> <span class="o">&lt;&lt;-</span><span class="sh">&quot;</span><span class="no">INSTALL</span><span class="sh">&quot;</span> <span class="p">;</span> <span class="nb">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">)</span> <span class="k">unless</span> <span class="no">RestClient</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;http://localhost:9200&#39;</span><span class="p">)</span> <span class="k">rescue</span> <span class="kp">false</span>
<span class="sh"> [!] You don’t appear to have ElasticSearch installed. Please install and launch it with the following commands.</span>
<span class="sh"> curl -k -L -o elasticsearch-0.15.0.tar.gz http://github.com/downloads/elasticsearch/elasticsearch/elasticsearch-0.15.0.tar.gz</span>
<span class="sh"> tar -zxvf elasticsearch-0.15.0.tar.gz</span>
<span class="sh"> ./elasticsearch-0.15.0/bin/elasticsearch -f</span>
<span class="no">INSTALL</span></pre></div>
      </td>
    </tr>
    <tr id='section-Simple_Usage'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Simple_Usage">&#182;</a>
        </div>
        <h2>Simple Usage</h2>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-Storing_and_indexing_documents'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Storing_and_indexing_documents">&#182;</a>
        </div>
        <h3>Storing and indexing documents</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <p>Let&rsquo;s initialize an index named “articles”.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="no">Slingshot</span><span class="o">.</span><span class="n">index</span> <span class="s1">&#39;articles&#39;</span> <span class="k">do</span></pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-9">&#182;</a>
        </div>
        <p>To make sure it&rsquo;s fresh, let&rsquo;s delete any existing index with the same name.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">delete</span></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <p>And then, let&rsquo;s create it.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">create</span></pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-11">&#182;</a>
        </div>
        <p>We want to store and index some articles with title and tags. Simple Hashes are OK.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">store</span> <span class="ss">:title</span> <span class="o">=&gt;</span> <span class="s1">&#39;One&#39;</span><span class="p">,</span>   <span class="ss">:tags</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s1">&#39;ruby&#39;</span><span class="o">]</span>
  <span class="n">store</span> <span class="ss">:title</span> <span class="o">=&gt;</span> <span class="s1">&#39;Two&#39;</span><span class="p">,</span>   <span class="ss">:tags</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s1">&#39;ruby&#39;</span><span class="p">,</span> <span class="s1">&#39;python&#39;</span><span class="o">]</span>
  <span class="n">store</span> <span class="ss">:title</span> <span class="o">=&gt;</span> <span class="s1">&#39;Three&#39;</span><span class="p">,</span> <span class="ss">:tags</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s1">&#39;java&#39;</span><span class="o">]</span>
  <span class="n">store</span> <span class="ss">:title</span> <span class="o">=&gt;</span> <span class="s1">&#39;Four&#39;</span><span class="p">,</span>  <span class="ss">:tags</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s1">&#39;ruby&#39;</span><span class="p">,</span> <span class="s1">&#39;php&#39;</span><span class="o">]</span></pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-12">&#182;</a>
        </div>
        <p>We force refreshing the index, so we can query it immediately.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">refresh</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-13">&#182;</a>
        </div>
        <p>We may want to define a specific <a href="http://www.elasticsearch.org/guide/reference/api/admin-indices-create-index.html">mapping</a>
for the index.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="no">Slingshot</span><span class="o">.</span><span class="n">index</span> <span class="s1">&#39;articles&#39;</span> <span class="k">do</span></pre></div>
      </td>
    </tr>
    <tr id='section-14'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-14">&#182;</a>
        </div>
        <p>To do so, just pass a Hash containing the specified mapping to the <code>Index#create</code> method.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">create</span> <span class="ss">:mappings</span> <span class="o">=&gt;</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-15'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-15">&#182;</a>
        </div>
        <p>Specify for which type of documents this mapping should be used (<code>article</code> in this case).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="ss">:article</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="ss">:properties</span> <span class="o">=&gt;</span> <span class="p">{</span></pre></div>
      </td>
    </tr>
    <tr id='section-16'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-16">&#182;</a>
        </div>
        <p>Specify the type of the field, whether it should be analyzed, etc.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="ss">:id</span>       <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="ss">:index</span> <span class="o">=&gt;</span> <span class="s1">&#39;not_analyzed&#39;</span><span class="p">,</span> <span class="ss">:include_in_all</span> <span class="o">=&gt;</span> <span class="kp">false</span> <span class="p">},</span></pre></div>
      </td>
    </tr>
    <tr id='section-17'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-17">&#182;</a>
        </div>
        <p>Set the boost or analyzer settings for the field, et cetera. The <em>ElasticSearch</em> guide
has <a href="http://elasticsearch.org/guide/reference/mapping/index.html">more information</a>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>        <span class="ss">:title</span>    <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="ss">:boost</span> <span class="o">=&gt;</span> <span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="p">,</span>            <span class="ss">:analyzer</span> <span class="o">=&gt;</span> <span class="s1">&#39;snowball&#39;</span>  <span class="p">},</span>
        <span class="ss">:tags</span>     <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="ss">:analyzer</span> <span class="o">=&gt;</span> <span class="s1">&#39;keyword&#39;</span>                             <span class="p">},</span>
        <span class="ss">:content</span>  <span class="o">=&gt;</span> <span class="p">{</span> <span class="ss">:type</span> <span class="o">=&gt;</span> <span class="s1">&#39;string&#39;</span><span class="p">,</span> <span class="ss">:analyzer</span> <span class="o">=&gt;</span> <span class="s1">&#39;snowball&#39;</span>                            <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-Searching'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Searching">&#182;</a>
        </div>
        <h3>Searching</h3>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-19'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-19">&#182;</a>
        </div>
        <p>With the documents indexed and stored in the <em>ElasticSearch</em> database, we want to search for them.</p>

<p>Slingshot exposes the search interface via simple domain-specific language.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-Simple_Query_String_Searches'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Simple_Query_String_Searches">&#182;</a>
        </div>
        <h4>Simple Query String Searches</h4>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-21'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-21">&#182;</a>
        </div>
        <p>We can do simple searches, like searching for articles containing “One” in their title.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">s</span> <span class="o">=</span> <span class="no">Slingshot</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;articles&#39;</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">query</span> <span class="k">do</span>
    <span class="n">string</span> <span class="s2">&quot;title:One&quot;</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-22'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-22">&#182;</a>
        </div>
        <p>The results:</p>

<pre><code>* One [tags: ruby]
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">s</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">document</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">&quot;* </span><span class="si">#{</span> <span class="n">document</span><span class="o">.</span><span class="n">title</span> <span class="si">}</span><span class="s2"> [tags: </span><span class="si">#{</span><span class="n">document</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">]&quot;</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-23'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-23">&#182;</a>
        </div>
        <p>Of course, we may write the blocks in shorter notation.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-24'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-24">&#182;</a>
        </div>
        <p>Let&rsquo;s search for articles whose titles begin with letter “T”.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">s</span> <span class="o">=</span> <span class="no">Slingshot</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;articles&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="n">query</span> <span class="p">{</span> <span class="n">string</span> <span class="s2">&quot;title:T*&quot;</span> <span class="p">}</span> <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-25'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-25">&#182;</a>
        </div>
        <p>The results:</p>

<pre><code>* Two [tags: ruby, python]
* Three [tags: java]
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">s</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">document</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">&quot;* </span><span class="si">#{</span> <span class="n">document</span><span class="o">.</span><span class="n">title</span> <span class="si">}</span><span class="s2"> [tags: </span><span class="si">#{</span><span class="n">document</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">]&quot;</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-26'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-26">&#182;</a>
        </div>
        <p>We can use any valid <a href="http://lucene.apache.org/java/3_0_3/queryparsersyntax.html">Lucene query syntax</a>
for the query string queries.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-27'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-27">&#182;</a>
        </div>
        <p>For debugging, we can display the JSON which is being sent to <em>ElasticSearch</em>.</p>

<pre><code>{"query":{"query_string":{"query":"title:T*"}}}
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">puts</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Query:&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">80</span>
<span class="nb">puts</span> <span class="n">s</span><span class="o">.</span><span class="n">to_json</span></pre></div>
      </td>
    </tr>
    <tr id='section-28'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-28">&#182;</a>
        </div>
        <p>Or better, we may display a complete <code>curl</code> command, so we can execute it in terminal
to see the raw output, tweak params and debug any problems.</p>

<pre><code>curl -X POST "http://localhost:9200/articles/_search?pretty=true" \
     -d '{"query":{"query_string":{"query":"title:T*"}}}'
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">puts</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;Try the query in Curl:&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">80</span>
<span class="nb">puts</span> <span class="n">s</span><span class="o">.</span><span class="n">to_curl</span></pre></div>
      </td>
    </tr>
    <tr id='section-Other_Types_of_Queries'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Other_Types_of_Queries">&#182;</a>
        </div>
        <h4>Other Types of Queries</h4>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-30'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-30">&#182;</a>
        </div>
        <p>Of course, we may want to define our queries more expressively, for instance
when we&rsquo;re searching for articles with specific <em>tags</em>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-31'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-31">&#182;</a>
        </div>
        <p>Let&rsquo;s suppose we want to search for articles tagged “ruby” <em>or</em> “python”.
That&rsquo;s a great excuse to use a <a href="http://elasticsearch.org/guide/reference/query-dsl/terms-query.html"><em>terms</em></a>
query.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">s</span> <span class="o">=</span> <span class="no">Slingshot</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;articles&#39;</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">query</span> <span class="k">do</span>
    <span class="n">terms</span> <span class="ss">:tags</span><span class="p">,</span> <span class="o">[</span><span class="s1">&#39;ruby&#39;</span><span class="p">,</span> <span class="s1">&#39;python&#39;</span><span class="o">]</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-32'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-32">&#182;</a>
        </div>
        <p>The search, as expected, returns three articles, all tagged “ruby” — among other tags:</p>

<pre><code>* Two [tags: ruby, python]
* One [tags: ruby]
* Four [tags: ruby, php]
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">s</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">document</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">&quot;* </span><span class="si">#{</span> <span class="n">document</span><span class="o">.</span><span class="n">title</span> <span class="si">}</span><span class="s2"> [tags: </span><span class="si">#{</span><span class="n">document</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">]&quot;</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-33'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-33">&#182;</a>
        </div>
        <p>What if we wanted to search for articles tagged both “ruby” <em>and</em> “python”.
That&rsquo;s a great excuse to specify <code>minimum_match</code> for the query.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">s</span> <span class="o">=</span> <span class="no">Slingshot</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;articles&#39;</span><span class="p">)</span> <span class="k">do</span>
  <span class="n">query</span> <span class="k">do</span>
    <span class="n">terms</span> <span class="ss">:tags</span><span class="p">,</span> <span class="o">[</span><span class="s1">&#39;ruby&#39;</span><span class="p">,</span> <span class="s1">&#39;python&#39;</span><span class="o">]</span><span class="p">,</span> <span class="ss">:minimum_match</span> <span class="o">=&gt;</span> <span class="mi">2</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-34'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-34">&#182;</a>
        </div>
        <p>The search, as expected, returns one article, tagged with <em>both</em> “ruby” and “python”:</p>

<pre><code>* Two [tags: ruby, python]
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">s</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">document</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">&quot;* </span><span class="si">#{</span> <span class="n">document</span><span class="o">.</span><span class="n">title</span> <span class="si">}</span><span class="s2"> [tags: </span><span class="si">#{</span><span class="n">document</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">]&quot;</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-35'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-35">&#182;</a>
        </div>
        <p><em>ElasticSearch</em> allows us to do many more types of queries.
Eventually, <em>Slingshot</em> will support all of them.
So far, only these are supported:</p>

<ul>
<li><a href="http://elasticsearch.org/guide/reference/query-dsl/term-query.html">term</a></li>
<li><a href="http://elasticsearch.org/guide/reference/query-dsl/terms-query.html">terms</a></li>
</ul>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-Faceted_Search'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Faceted_Search">&#182;</a>
        </div>
        <h4>Faceted Search</h4>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-37'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-37">&#182;</a>
        </div>
        <p><em>ElasticSearch</em> makes it trivial to retrieve complex aggregated data from our index/database,
so called <a href="http://www.lucidimagination.com/Community/Hear-from-the-Experts/Articles/Faceted-Search-Solr"><em>facets</em></a>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-38'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-38">&#182;</a>
        </div>
        <p>Let&rsquo;s say we want to display article counts for every tag in the database.
For that, we&rsquo;ll use a <em>terms</em> facet.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-39'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-39">&#182;</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">s</span> <span class="o">=</span> <span class="no">Slingshot</span><span class="o">.</span><span class="n">search</span> <span class="s1">&#39;articles&#39;</span> <span class="k">do</span></pre></div>
      </td>
    </tr>
    <tr id='section-40'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-40">&#182;</a>
        </div>
        <p>We will search for articles whose title begins with letter “T”,</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">query</span> <span class="p">{</span> <span class="n">string</span> <span class="s1">&#39;title:T*&#39;</span> <span class="p">}</span></pre></div>
      </td>
    </tr>
    <tr id='section-41'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-41">&#182;</a>
        </div>
        <p>and retrieve their counts “bucketed” by their <code>tags</code>.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">facet</span> <span class="s1">&#39;tags&#39;</span> <span class="k">do</span>
    <span class="n">terms</span> <span class="ss">:tags</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-42'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-42">&#182;</a>
        </div>
        <p>As we see, our query has found two articles, and if you recall our articles from above,
<em>Two</em> is tagged with “ruby” and “python”, <em>Three</em> is tagged with “java”. So the counts
won&rsquo;t surprise us:</p>

<pre><code>Found 2 articles: Three, Two
Counts:
-------
ruby       1
python     1
java       1
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">puts</span> <span class="s2">&quot;Found </span><span class="si">#{</span><span class="n">s</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">count</span><span class="si">}</span><span class="s2"> articles: </span><span class="si">#{</span><span class="n">s</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:title</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="nb">puts</span> <span class="s2">&quot;Counts based on tags:&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">25</span>
<span class="n">s</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">facets</span><span class="o">[</span><span class="s1">&#39;tags&#39;</span><span class="o">][</span><span class="s1">&#39;terms&#39;</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">f</span><span class="o">[</span><span class="s1">&#39;term&#39;</span><span class="o">].</span><span class="n">ljust</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">f</span><span class="o">[</span><span class="s1">&#39;count&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-43'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-43">&#182;</a>
        </div>
        <p>These counts are based on the scope of our current query (called <code>main</code> in <em>ElasticSearch</em>).
What if we wanted to display aggregated counts by <code>tags</code> across the whole database?</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-44'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-44">&#182;</a>
        </div>
        
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">s</span> <span class="o">=</span> <span class="no">Slingshot</span><span class="o">.</span><span class="n">search</span> <span class="s1">&#39;articles&#39;</span> <span class="k">do</span>
  <span class="n">query</span> <span class="p">{</span> <span class="n">string</span> <span class="s1">&#39;title:T*&#39;</span> <span class="p">}</span>

  <span class="n">facet</span> <span class="s1">&#39;global-tags&#39;</span> <span class="k">do</span></pre></div>
      </td>
    </tr>
    <tr id='section-45'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-45">&#182;</a>
        </div>
        <p>That&rsquo;s where the <code>global</code> scope for a facet comes in.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="n">terms</span> <span class="ss">:tags</span><span class="p">,</span> <span class="ss">:global</span> <span class="o">=&gt;</span> <span class="kp">true</span>
  <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-46'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-46">&#182;</a>
        </div>
        <p>As you can see, we can even combine facets scoped
to the current query with global facets.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">facet</span> <span class="s1">&#39;current-tags&#39;</span> <span class="k">do</span>
    <span class="n">terms</span> <span class="ss">:tags</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-47'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-47">&#182;</a>
        </div>
        <p>Aggregated results for the current query are the same as previously:</p>

<pre><code>Current query facets:
-------------------------
ruby       1
python     1
java       1
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">puts</span> <span class="s2">&quot;Current query facets:&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">25</span>
<span class="n">s</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">facets</span><span class="o">[</span><span class="s1">&#39;current-tags&#39;</span><span class="o">][</span><span class="s1">&#39;terms&#39;</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">f</span><span class="o">[</span><span class="s1">&#39;term&#39;</span><span class="o">].</span><span class="n">ljust</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">f</span><span class="o">[</span><span class="s1">&#39;count&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-48'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-48">&#182;</a>
        </div>
        <p>As we see, aggregated results for the global scope include also
tags for articles not matched by the query, such as “java” or “php”:</p>

<pre><code>Global facets:
-------------------------
ruby       3
python     1
php        1
java       1
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">puts</span> <span class="s2">&quot;Global facets:&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">25</span>
<span class="n">s</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">facets</span><span class="o">[</span><span class="s1">&#39;global-tags&#39;</span><span class="o">][</span><span class="s1">&#39;terms&#39;</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">f</span><span class="o">[</span><span class="s1">&#39;term&#39;</span><span class="o">].</span><span class="n">ljust</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">f</span><span class="o">[</span><span class="s1">&#39;count&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-49'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-49">&#182;</a>
        </div>
        <p>The real power of facets lies in their combination with
<a href="http://elasticsearch.karmi.cz/guide/reference/api/search/filter.html">filters</a>,
though:</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-50'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-50">&#182;</a>
        </div>
        <blockquote><p>When doing things like facet navigation,
sometimes only the hits are needed to be filtered by the chosen facet,
and all the facets should continue to be calculated based on the original query.</p></blockquote>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-Filtered_Search'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Filtered_Search">&#182;</a>
        </div>
        <h4>Filtered Search</h4>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-52'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-52">&#182;</a>
        </div>
        <p>So, let&rsquo;s make out search a bit complex. Let&rsquo;s search for articles whose titles begin
with letter “T”, again, but filter the results, so only the articles tagged “ruby”
are returned.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">s</span> <span class="o">=</span> <span class="no">Slingshot</span><span class="o">.</span><span class="n">search</span> <span class="s1">&#39;articles&#39;</span> <span class="k">do</span>
  </pre></div>
      </td>
    </tr>
    <tr id='section-53'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-53">&#182;</a>
        </div>
        <p>We use the same <strong>query</strong> as before.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">query</span> <span class="p">{</span> <span class="n">string</span> <span class="s1">&#39;title:T*&#39;</span> <span class="p">}</span> </pre></div>
      </td>
    </tr>
    <tr id='section-54'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-54">&#182;</a>
        </div>
        <p>And add a <em>terms</em> <strong>filter</strong> based on tags.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">filter</span> <span class="ss">:terms</span><span class="p">,</span> <span class="ss">:tags</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="s1">&#39;ruby&#39;</span><span class="o">]</span></pre></div>
      </td>
    </tr>
    <tr id='section-55'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-55">&#182;</a>
        </div>
        <p>And, of course, our facet definition.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">facet</span><span class="p">(</span><span class="s1">&#39;tags&#39;</span><span class="p">)</span> <span class="p">{</span> <span class="n">terms</span> <span class="ss">:tags</span> <span class="p">}</span>

<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-56'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-56">&#182;</a>
        </div>
        <p>We see that only the article <em>Two</em> (tagged “ruby” and “python”) was returned,
<em>not</em> the article <em>Three</em> (tagged “java”):</p>

<pre><code>* Two [tags: ruby, python]
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">s</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">document</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">&quot;* </span><span class="si">#{</span> <span class="n">document</span><span class="o">.</span><span class="n">title</span> <span class="si">}</span><span class="s2"> [tags: </span><span class="si">#{</span><span class="n">document</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">]&quot;</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-57'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-57">&#182;</a>
        </div>
        <p>However, count for article <em>Three</em>&rsquo;s tags, “java”, <em>is</em> in fact included in facets:</p>

<pre><code>Counts based on tags:
-------------------------
ruby       1
python     1
java       1
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="nb">puts</span> <span class="s2">&quot;Counts based on tags:&quot;</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">25</span>
<span class="n">s</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">facets</span><span class="o">[</span><span class="s1">&#39;tags&#39;</span><span class="o">][</span><span class="s1">&#39;terms&#39;</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">f</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">f</span><span class="o">[</span><span class="s1">&#39;term&#39;</span><span class="o">].</span><span class="n">ljust</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">f</span><span class="o">[</span><span class="s1">&#39;count&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-Sorting'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-Sorting">&#182;</a>
        </div>
        <h4>Sorting</h4>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-59'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-59">&#182;</a>
        </div>
        <p>By default, the results are sorted according to their relevancy
(available as the <code>_score</code> property).</p>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-60'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-60">&#182;</a>
        </div>
        <p>But, what if we want to sort the results based on some other criteria,
such as published date, price, etc? We can do that.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">s</span> <span class="o">=</span> <span class="no">Slingshot</span><span class="o">.</span><span class="n">search</span> <span class="s1">&#39;articles&#39;</span> <span class="k">do</span></pre></div>
      </td>
    </tr>
    <tr id='section-61'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-61">&#182;</a>
        </div>
        <p>We search for articles tagged “ruby”</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">query</span> <span class="p">{</span> <span class="n">string</span> <span class="s1">&#39;tags:ruby&#39;</span> <span class="p">}</span> </pre></div>
      </td>
    </tr>
    <tr id='section-62'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-62">&#182;</a>
        </div>
        <p>And sort them by their <code>title</code>, in descending order.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">sort</span> <span class="p">{</span> <span class="n">title</span> <span class="s1">&#39;desc&#39;</span> <span class="p">}</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-63'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-63">&#182;</a>
        </div>
        <p>The results:</p>

<pre><code>* Two
* One
* Four
</code></pre>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">s</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">document</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">&quot;* </span><span class="si">#{</span> <span class="n">document</span><span class="o">.</span><span class="n">title</span> <span class="si">}</span><span class="s2">&quot;</span>
<span class="k">end</span>


<span class="n">s</span> <span class="o">=</span> <span class="no">Slingshot</span><span class="o">.</span><span class="n">search</span> <span class="s1">&#39;articles&#39;</span> <span class="k">do</span></pre></div>
      </td>
    </tr>
    <tr id='section-64'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-64">&#182;</a>
        </div>
        <p>We search for articles tagged “ruby”</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">query</span> <span class="p">{</span> <span class="n">string</span> <span class="s1">&#39;tags:ruby&#39;</span> <span class="p">}</span> </pre></div>
      </td>
    </tr>
    <tr id='section-65'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-65">&#182;</a>
        </div>
        <p>And sort them by their <code>title</code>, in descending order.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>  <span class="n">sort</span> <span class="k">do</span>
    <span class="n">title</span> <span class="s1">&#39;desc&#39;</span>
    <span class="n">_score</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-66'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-66">&#182;</a>
        </div>
        <p>The results:</p>

<pre><code>* Two
* One
* Four
</code></pre>

      </td>
      <td class=code>
        <div class='highlight'><pre><span class="n">s</span><span class="o">.</span><span class="n">results</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">document</span><span class="o">|</span>
  <span class="nb">puts</span> <span class="s2">&quot;* </span><span class="si">#{</span> <span class="n">document</span><span class="o">.</span><span class="n">title</span> <span class="si">}</span><span class="s2">&quot;</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
